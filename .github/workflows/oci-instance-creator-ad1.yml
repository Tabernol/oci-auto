name: OCI A1 Instance Creator AD1

on:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ”Ñ‚ÑŒÑÑ ÐºÐ¾Ð¶Ð½Ñ– 10 Ñ…Ð²Ð¸Ð»Ð¸Ð½
    - cron: '*/10 * * * *'
  workflow_dispatch: # ÐœÐ¾Ð¶Ð½Ð° Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ð¸ Ð²Ñ€ÑƒÑ‡Ð½Ñƒ

env:
  INSTANCE_NAME: a1-ad1
  OCI_AVAILABILITY_DOMAIN: roRp:PHX-AD-1

jobs:
  create-instance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install OCI CLI
        run: |
          pip install oci-cli

      - name: Create OCI Config
        run: |
          mkdir -p ~/.oci
          echo "[DEFAULT]" > ~/.oci/config
          echo "user=${{ secrets.OCI_USER_OCID }}" >> ~/.oci/config
          echo "fingerprint=${{ secrets.OCI_FINGERPRINT }}" >> ~/.oci/config
          echo "tenancy=${{ secrets.OCI_TENANCY_OCID }}" >> ~/.oci/config
          echo "region=${{ secrets.OCI_REGION }}" >> ~/.oci/config
          echo "key_file=~/.oci/key.pem" >> ~/.oci/config
          
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/key.pem
          chmod 600 ~/.oci/key.pem

      - name: Try to create A1 instance
        env:
          SSH_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
        run: |
          python3 << 'EOF'
          import oci
          import sys
          import os
          from datetime import datetime
          
          print(f"[{datetime.now()}] Ð¡Ð¿Ñ€Ð¾Ð±Ð° ÑÑ‚Ð²Ð¾Ñ€Ð¸Ñ‚Ð¸ A1 Ñ–Ð½ÑÑ‚Ð°Ð½Ñ...")
          
          # Ð†Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ OCI config
          config = oci.config.from_file("~/.oci/config", "DEFAULT")
          compute_client = oci.core.ComputeClient(config)
          
          # ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¸ Ñ–Ð½ÑÑ‚Ð°Ð½ÑÑƒ
          instance_name = "${{ env.INSTANCE_NAME }}"
          compartment_id = "${{ secrets.OCI_COMPARTMENT_OCID }}"
          availability_domain = "${{ env.OCI_AVAILABILITY_DOMAIN }}"
          subnet_id = "${{ secrets.OCI_SUBNET_OCID }}"
          image_id = "${{ secrets.OCI_IMAGE_OCID }}"
          ssh_public_key = os.environ.get('SSH_KEY', '')
          
          # ÐšÐ¾Ð½Ñ„Ñ–Ð³ÑƒÑ€Ð°Ñ†Ñ–Ñ shape
          shape_config = oci.core.models.LaunchInstanceShapeConfigDetails(
              ocpus=1.0,
              memory_in_gbs=6.0
          )
          
          # Ð”ÐµÑ‚Ð°Ð»Ñ– Ñ–Ð½ÑÑ‚Ð°Ð½ÑÑƒ
          instance_details = oci.core.models.LaunchInstanceDetails(
              availability_domain=availability_domain,
              compartment_id=compartment_id,
              shape="VM.Standard.A1.Flex",
              shape_config=shape_config,
              display_name=instance_name,
              source_details=oci.core.models.InstanceSourceViaImageDetails(
                  image_id=image_id,
                  source_type="image"
              ),
              create_vnic_details=oci.core.models.CreateVnicDetails(
                  subnet_id=subnet_id,
                  assign_public_ip=True
              ),
              metadata={
                  "ssh_authorized_keys": ssh_public_key
              }
          )
          
          try:
              # Ð¡Ð¿Ñ€Ð¾Ð±Ð° ÑÑ‚Ð²Ð¾Ñ€Ð¸Ñ‚Ð¸ Ñ–Ð½ÑÑ‚Ð°Ð½Ñ
              response = compute_client.launch_instance(instance_details)
          
              print(f"âœ… Ð£Ð¡ÐŸÐ†Ð¥! Ð†Ð½ÑÑ‚Ð°Ð½Ñ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð¾!")
              print(f"Instance ID: {response.data.id}")
              print(f"Lifecycle State: {response.data.lifecycle_state}")
          
              sys.exit(0)
          
          except oci.exceptions.ServiceError as e:
              if e.status == 500 and "Out of host capacity" in str(e):
                  print(f"âŒ ÐÐµÐ¼Ð°Ñ” capacity. Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÑŽ Ð·Ð½Ð¾Ð²Ñƒ Ñ‡ÐµÑ€ÐµÐ· 10 Ñ…Ð²Ð¸Ð»Ð¸Ð½...")
                  sys.exit(0)  # ÐÐµ Ñ„ÐµÐ¹Ð»Ð¸Ð¼Ð¾ workflow
              elif "NotAuthorizedOrNotFound" in str(e):
                  print(f"âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ñ–Ñ— Ð°Ð±Ð¾ Ñ€ÐµÑÑƒÑ€Ñ Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾")
                  print(f"Ð”ÐµÑ‚Ð°Ð»Ñ–: {e}")
                  sys.exit(1)
              else:
                  print(f"âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ°: {e}")
                  sys.exit(1)
          
          except Exception as e:
              print(f"âŒ ÐÐµÑÐ¿Ð¾Ð´Ñ–Ð²Ð°Ð½Ð° Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ°: {e}")
              sys.exit(1)
          EOF
        continue-on-error: false

      - name: Notification on success
        if: success()
        run: |
          echo "ðŸŽ‰ Workflow Ð²Ð¸ÐºÐ¾Ð½Ð°Ð½Ð¾ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾!"