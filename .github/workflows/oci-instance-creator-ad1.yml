#name: OCI A1 Instance Creator AD1
#
#on:
#  schedule:
#    # Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ”Ñ‚ÑŒÑÑ ÐºÐ¾Ð¶Ð½Ñ– 0 Ñ…Ð²Ð¸Ð»Ð¸Ð½
#    - cron: '0 * * * *'
#  workflow_dispatch: # ÐœÐ¾Ð¶Ð½Ð° Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ð¸ Ð²Ñ€ÑƒÑ‡Ð½Ñƒ
#
#env:
#  INSTANCE_NAME: krasiot-ui
#  OCI_AVAILABILITY_DOMAIN: roRp:PHX-AD-1
#
#jobs:
#  create-instance:
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      - name: Set up Python
#        uses: actions/setup-python@v4
#        with:
#          python-version: '3.11'
#
#      - name: Install OCI CLI
#        run: |
#          pip install oci-cli
#
#      - name: Create OCI Config
#        run: |
#          mkdir -p ~/.oci
#          echo "[DEFAULT]" > ~/.oci/config
#          echo "user=${{ secrets.OCI_USER_OCID }}" >> ~/.oci/config
#          echo "fingerprint=${{ secrets.OCI_FINGERPRINT }}" >> ~/.oci/config
#          echo "tenancy=${{ secrets.OCI_TENANCY_OCID }}" >> ~/.oci/config
#          echo "region=${{ secrets.OCI_REGION }}" >> ~/.oci/config
#          echo "key_file=~/.oci/key.pem" >> ~/.oci/config
#
#          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/key.pem
#          chmod 600 ~/.oci/key.pem
#
#      - name: Check and create A1 instance
#        env:
#          SSH_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
#        run: |
#          python3 << 'EOF'
#          import oci
#          import sys
#          import os
#          from datetime import datetime
#
#          print(f"[{datetime.now()}] ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ñ‚Ð° ÑÐ¿Ñ€Ð¾Ð±Ð° ÑÑ‚Ð²Ð¾Ñ€Ð¸Ñ‚Ð¸ A1 Ñ–Ð½ÑÑ‚Ð°Ð½Ñ...")
#
#          # Ð†Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ OCI config
#          config = oci.config.from_file("~/.oci/config", "DEFAULT")
#          compute_client = oci.core.ComputeClient(config)
#
#          # ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¸ Ñ–Ð½ÑÑ‚Ð°Ð½ÑÑƒ
#          instance_name = "${{ env.INSTANCE_NAME }}"
#          compartment_id = "${{ secrets.OCI_COMPARTMENT_OCID }}"
#          availability_domain = "${{ env.OCI_AVAILABILITY_DOMAIN }}"
#          subnet_id = "${{ secrets.OCI_SUBNET_OCID }}"
#          image_id = "${{ secrets.OCI_IMAGE_OCID }}"
#          ssh_public_key = os.environ.get('SSH_KEY', '')
#
#          # ============================================
#          # ÐŸÐ•Ð Ð•Ð’Ð†Ð ÐšÐ Ð§Ð˜ Ð’Ð–Ð• Ð†Ð¡ÐÐ£Ð„ Ð†ÐÐ¡Ð¢ÐÐÐ¡
#          # ============================================
#          try:
#              print(f"ðŸ” ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑŽ Ñ‡Ð¸ Ñ–ÑÐ½ÑƒÑ” Ñ–Ð½ÑÑ‚Ð°Ð½Ñ Ð· Ñ–Ð¼ÐµÐ½ÐµÐ¼ '{instance_name}'...")
#
#              existing_instances = compute_client.list_instances(
#                  compartment_id=compartment_id,
#                  display_name=instance_name,
#                  lifecycle_state="RUNNING"
#              ).data
#
#              if existing_instances:
#                  print(f"âœ… Ð†Ð½ÑÑ‚Ð°Ð½Ñ '{instance_name}' Ð²Ð¶Ðµ Ñ–ÑÐ½ÑƒÑ” Ñ‚Ð° Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¸Ð¹!")
#                  print(f"Instance ID: {existing_instances[0].id}")
#                  print(f"Lifecycle State: {existing_instances[0].lifecycle_state}")
#                  print(f"â¹ï¸  ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÑŽ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ. Ð’Ð¸Ð¼ÐºÐ½Ñ–Ñ‚ÑŒ Ñ†ÐµÐ¹ workflow!")
#                  # Ð’Ð¸Ñ…Ñ–Ð´ Ð· Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ¾ÑŽ Ñ‰Ð¾Ð± Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ Ð½Ð° Ð¿Ð¾ÑˆÑ‚Ñƒ
#                  sys.exit(1)
#
#              # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ñ–Ð½ÑÑ‚Ð°Ð½ÑÑ–Ð² Ñ‰Ð¾ ÑÑ‚Ð²Ð¾Ñ€ÑŽÑŽÑ‚ÑŒÑÑ
#              creating_instances = compute_client.list_instances(
#                  compartment_id=compartment_id,
#                  display_name=instance_name,
#                  lifecycle_state="PROVISIONING"
#              ).data
#
#              if creating_instances:
#                  print(f"â³ Ð†Ð½ÑÑ‚Ð°Ð½Ñ '{instance_name}' Ð·Ð°Ñ€Ð°Ð· ÑÑ‚Ð²Ð¾Ñ€ÑŽÑ”Ñ‚ÑŒÑÑ...")
#                  print(f"Instance ID: {creating_instances[0].id}")
#                  print(f"â¹ï¸  ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÑŽ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ. Ð—Ð°Ñ‡ÐµÐºÐ°Ð¹Ñ‚Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ.")
#                  sys.exit(0)
#
#              print(f"âœ… Ð†Ð½ÑÑ‚Ð°Ð½Ñ Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾, Ð¼Ð¾Ð¶Ð½Ð° ÑÑ‚Ð²Ð¾Ñ€ÑŽÐ²Ð°Ñ‚Ð¸.")
#
#          except Exception as e:
#              print(f"âš ï¸  ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð¿Ñ€Ð¸ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€Ñ†Ñ– Ñ–ÑÐ½ÑƒÑŽÑ‡Ð¸Ñ… Ñ–Ð½ÑÑ‚Ð°Ð½ÑÑ–Ð²: {e}")
#              print(f"ÐŸÑ€Ð¾Ð´Ð¾Ð²Ð¶ÑƒÑŽ ÑÐ¿Ñ€Ð¾Ð±Ñƒ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ...")
#
#          # ============================================
#          # Ð¡Ð¢Ð’ÐžÐ Ð•ÐÐÐ¯ Ð†ÐÐ¡Ð¢ÐÐÐ¡Ð£
#          # ============================================
#
#          # ÐšÐ¾Ð½Ñ„Ñ–Ð³ÑƒÑ€Ð°Ñ†Ñ–Ñ shape
#          shape_config = oci.core.models.LaunchInstanceShapeConfigDetails(
#              ocpus=1.0,
#              memory_in_gbs=6.0
#          )
#
#          # Ð”ÐµÑ‚Ð°Ð»Ñ– Ñ–Ð½ÑÑ‚Ð°Ð½ÑÑƒ
#          instance_details = oci.core.models.LaunchInstanceDetails(
#              availability_domain=availability_domain,
#              compartment_id=compartment_id,
#              shape="VM.Standard.A1.Flex",
#              shape_config=shape_config,
#              display_name=instance_name,
#              source_details=oci.core.models.InstanceSourceViaImageDetails(
#                  image_id=image_id,
#                  source_type="image"
#              ),
#              create_vnic_details=oci.core.models.CreateVnicDetails(
#                  subnet_id=subnet_id,
#                  assign_public_ip=True
#              ),
#              metadata={
#                  "ssh_authorized_keys": ssh_public_key
#              }
#          )
#
#          try:
#              # Ð¡Ð¿Ñ€Ð¾Ð±Ð° ÑÑ‚Ð²Ð¾Ñ€Ð¸Ñ‚Ð¸ Ñ–Ð½ÑÑ‚Ð°Ð½Ñ
#              response = compute_client.launch_instance(instance_details)
#
#              print(f"")
#              print(f"=" * 60)
#              print(f"âœ… Ð£Ð¡ÐŸÐ†Ð¥! Ð†Ð½ÑÑ‚Ð°Ð½Ñ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð¾!")
#              print(f"=" * 60)
#              print(f"Instance ID: {response.data.id}")
#              print(f"Instance Name: {response.data.display_name}")
#              print(f"Lifecycle State: {response.data.lifecycle_state}")
#              print(f"Availability Domain: {response.data.availability_domain}")
#              print(f"")
#              print(f"âš ï¸  Ð’ÐÐ–Ð›Ð˜Ð’Ðž: Ð’Ð˜ÐœÐšÐÐ†Ð¢Ð¬ Ð¦Ð•Ð™ WORKFLOW ÐžÐ”Ð ÐÐ—Ð£!")
#              print(f"=" * 60)
#
#              sys.exit(0)
#
#          except oci.exceptions.ServiceError as e:
#              if e.status == 500 and "Out of host capacity" in str(e):
#                  print(f"âŒ ÐÐµÐ¼Ð°Ñ” capacity Ð² {availability_domain}.")
#                  print(f"â³ Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÑŽ Ð·Ð½Ð¾Ð²Ñƒ Ñ‡ÐµÑ€ÐµÐ· 10 Ñ…Ð²Ð¸Ð»Ð¸Ð½...")
#                  sys.exit(0)  # ÐÐµ Ñ„ÐµÐ¹Ð»Ð¸Ð¼Ð¾ workflow
#              elif "NotAuthorizedOrNotFound" in str(e):
#                  print(f"âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ñ–Ñ— Ð°Ð±Ð¾ Ñ€ÐµÑÑƒÑ€Ñ Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾")
#                  print(f"Ð”ÐµÑ‚Ð°Ð»Ñ–: {e}")
#                  sys.exit(1)
#              else:
#                  print(f"âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ°: {e}")
#                  sys.exit(1)
#
#          except Exception as e:
#              print(f"âŒ ÐÐµÑÐ¿Ð¾Ð´Ñ–Ð²Ð°Ð½Ð° Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ°: {e}")
#              sys.exit(1)
#          EOF
#        continue-on-error: false
#
#      - name: Notification on success
#        if: success()
#        run: |
#          echo "ðŸŽ‰ Workflow Ð²Ð¸ÐºÐ¾Ð½Ð°Ð½Ð¾ ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¾!"
